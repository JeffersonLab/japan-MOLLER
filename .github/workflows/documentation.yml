name: Generate and Publish Documentation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-docs:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # Full history for proper documentation generation

    - name: Clean up any existing documentation
      run: |
        rm -rf Doxygen/html/ || true
        rm -rf html/ || true
        echo "Cleaned up existing documentation directories"

    - name: Cache apt packages
      uses: actions/cache@v4
      with:
        path: |
          /var/cache/apt/archives
          /var/lib/apt/lists
        key: ${{ runner.os }}-apt-${{ hashFiles('**/.github/workflows/documentation.yml') }}
        restore-keys: |
          ${{ runner.os }}-apt-

    - name: Install Doxygen and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz plantuml texlive-latex-base texlive-latex-extra
        
    - name: Verify Doxygen installation
      run: |
        doxygen --version
        dot -V
        latex --version || echo "LaTeX installed for formula support"
        
    - name: Update Doxygen configuration (remove obsolete tags)
      run: |
        echo "Updating Doxyfile to remove obsolete tags..."
        doxygen -u Doxyfile || true
        
    - name: Generate Doxygen configuration info
      run: |
        echo "Doxygen configuration summary:"
        echo "PROJECT_NAME: $(grep '^PROJECT_NAME' Doxyfile | cut -d'=' -f2- | xargs)"
        echo "PROJECT_VERSION: $(grep '^PROJECT_VERSION' Doxyfile | cut -d'=' -f2- | xargs)"  
        echo "OUTPUT_DIRECTORY: $(grep '^OUTPUT_DIRECTORY' Doxyfile | cut -d'=' -f2- | xargs)"
        echo "GENERATE_HTML: $(grep '^GENERATE_HTML' Doxyfile | cut -d'=' -f2- | xargs)"
        echo "HTML_OUTPUT: $(grep '^HTML_OUTPUT' Doxyfile | cut -d'=' -f2- | xargs)"
        
    - name: Generate Doxygen documentation
      run: |
        echo "Generating Doxygen documentation..."
        echo "This may take several minutes for large codebases..."
        set -o pipefail
        doxygen Doxyfile 2>&1 | tee doxygen_output.log
        echo "Documentation generation completed!"
        
    - name: Check for critical errors
      run: |
        if grep -q "error.*Problems running" doxygen_output.log; then
          echo "⚠️  Some non-critical errors occurred (LaTeX formulas), but HTML documentation should still be generated"
        fi
        if grep -q "^Error:" doxygen_output.log; then
          echo "❌ Critical errors found in Doxygen output"
          exit 1
        fi
        
    - name: Check generated documentation
      run: |
        echo "Documentation generation completed. Checking output..."
        if [ -d "Doxygen/html" ]; then
          echo "✅ HTML documentation generated successfully"
          echo "Files generated: $(find Doxygen/html -name "*.html" | wc -l) HTML files"
          ls -la Doxygen/html/ | head -10
        elif [ -d "html" ]; then
          echo "✅ HTML documentation found in root html/ directory"
          echo "Files generated: $(find html -name "*.html" | wc -l) HTML files"
          ls -la html/ | head -10
        else
          echo "❌ HTML documentation not found"
          echo "Available directories:"
          find . -maxdepth 2 -type d -name "*html*" -o -name "*Doxygen*" || echo "No html/Doxygen directories found"
          ls -la Doxygen/ 2>/dev/null || echo "Doxygen/ directory not found"
          exit 1
        fi
        
    - name: Upload documentation artifacts (for PR preview)
      uses: actions/upload-artifact@v4
      with:
        name: doxygen-documentation
        path: Doxygen/html/
        retention-days: 30
        
    - name: Setup GitHub Pages (main branch only)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/configure-pages@v5
      
    - name: Upload to GitHub Pages (main branch only)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-pages-artifact@v4
      with:
        path: Doxygen/html/

  deploy-pages:
    # Only run deployment job for pushes to main branch
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    runs-on: ubuntu-24.04
    needs: generate-docs
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Output documentation URL
      run: |
        echo "📚 Documentation published successfully!"
        echo "🔗 URL: ${{ steps.deployment.outputs.page_url }}"
        echo ""
        echo "The JAPAN-MOLLER analysis framework documentation is now available at:"
        echo "${{ steps.deployment.outputs.page_url }}"